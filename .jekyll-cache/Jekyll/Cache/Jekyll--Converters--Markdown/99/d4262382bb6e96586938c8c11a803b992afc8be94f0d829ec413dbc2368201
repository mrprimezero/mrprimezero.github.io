I"—P<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/dnsmasq.jpg" alt="dnsmasq" />
<em>dnsmasq</em></p>

<p>Welcome back to the second installment of our cybersecurity home lab series! In our <a href="https://mrprimezero.github.io/posts/homelab_kalilinux/">previous post</a>, we established our attacker machine, Kali Linux, and prepared it for action. Now, we‚Äôre taking a critical step forward by building the perfect environment for it to operate in: a dedicated, isolated network.</p>

<p>Why is this so crucial? Because it allows us to simulate real-world scenarios without any risk to your home network. Instead of a messy, multi-VM configuration, we‚Äôll create a single, centralized server to handle all of our networking needs. In this guide, we‚Äôll leverage the lightweight and secure Alpine Linux to serve as our DHCP (Dynamic Host Configuration Protocol) and DNS (Domain System Name) server, using the powerful <code class="language-plaintext highlighter-rouge">dnsmasq</code> utility. This will give all our virtual machines their own private address space, just like in a real enterprise network.</p>

<p>The real reason why I built this DHCP server is because I beleive it is really a hassle how we need to manually enter an IP for each machine that we add on our isolated <code class="language-plaintext highlighter-rouge">SOC</code> network.</p>

<h2 id="installation">Installation</h2>
<p>Before we create our DHCP server we will have to download a light weight linux distribution which doesn‚Äôt take up much power so we can have it running while we run our other Virtual Machines, I have picked Alpine Linux since it has a command line interface and doesn‚Äôt take up much space and power. You may use any Linux distrobution that you desire.</p>

<h3 id="downloadables">Downloadables</h3>
<p>To get started you will need atleast 3GB free storage space and 512MB free RAM. Also you will have to download: <a href="https://www.virtualbox.org/wiki/Downloads">Oracle VirtualBox</a> and you need to download Alpine Linux standard ISO <a href="https://alpinelinux.org/downloads/">here</a>, make sure to install the x86_64 version of the standard ISO.</p>

<h3 id="virtual-machine-creation">Virtual Machine creation</h3>
<p>Once you have downloaded everything go on to virtualbox and click on <code class="language-plaintext highlighter-rouge">new</code> to create a new virtual machine.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/1.png" alt="New VM" />
<em>New VM</em></p>

<p>Once you do that you will this screen, So now give your machine a name and select a location on a drive with atleast 3GB free space. THen click on ISO image and select your downloaded <a href="https://alpinelinux.org/downloads/">Alpine Linux Standard ISO</a>. Set the Type to <code class="language-plaintext highlighter-rouge">Linux</code>, Subtype to <code class="language-plaintext highlighter-rouge">Other Linux</code> and the version as <code class="language-plaintext highlighter-rouge">Other Linux (64 bit)</code>.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/2.png" alt="Name and operating system" />
<em>Name and operating system</em></p>

<p>Now move to the Hardware section and select 512MB base memory and 1 CPU processor.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/3.png" alt="VM Hardware" />
<em>VM Hardware</em></p>

<p>Now move on to the Hard disk section and select ‚ÄúCreate a Virtual Hard Disk Now‚Äù and give it atleast 2GB storage space. Now once everything is done click <code class="language-plaintext highlighter-rouge">Finish</code>.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/4.png" alt="VM Storage" />
<em>VM Storage</em></p>

<h3 id="os-installation">OS Installation</h3>
<p>Once the VM creation is done click on start and boot into Alpine Linux. Once in you should login as <code class="language-plaintext highlighter-rouge">root</code> so just type as root in the terminal and you will log in, there will not be any password and you can log in. If there is any issue make sure you have downloaded the correct ISO file and followed the VM creation steps properly.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/5.png" alt="Root login" />
<em>Root</em></p>

<p>Once you are logged in you must install the OS. To do so type this in the terminal.</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">setup-alpine
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/6.png" alt="Alpine setup" />
<em>Alpine setup</em></p>

<p>Once the setup launches select your preferred keymap and hit enter.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/7.png" alt="Alpine keymap" />
<em>Alpine keymap</em></p>

<p>After selecting the keymap you will be asked to enter a hostname, Give a hostname you prefer and hit enter.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/8.png" alt="Alpine hostname" />
<em>Alpine hostname</em></p>

<p>After you have given the hostname you will prompted to initialize an interface, the defualt would be eth0 so hit enter on that [<code class="language-plaintext highlighter-rouge">Important note: If you have added more than 1 adapter when creating the virtual machine, disable it. There will be problems with the installation</code>]. Then you will be asked to provide ip address for eth0, the default is dhcp so again hit enter. Once that is done you will be prompted to do any manual network configuration, again go with the defualt which is no or n.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/9.png" alt="Alpine interface" />
<em>Alpine interface</em></p>

<p>Once the Interface setup is complete you will be asked to create a new password for <code class="language-plaintext highlighter-rouge">root</code> so give it a super secure super long password like I have. Also make sure you can remember the password.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/10.png" alt="Alpine root password" />
<em>Alpine root password</em></p>

<p>Once that is done, select your preferred timezone and hit enter.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/11.png" alt="Alpine timezone" />
<em>Alpine timezone</em></p>

<p>After that you will be prompted for HTTP/FTP proxy, for now leave it as none and hit enter.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/12.png" alt="Alpine proxy" />
<em>Alpine proxy</em></p>

<p>Now you will be prompted to select a Network Time Protocol, you may select any that you prefer but I have chosen chrony.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/13.png" alt="Alpine NTP" />
<em>Alpine NTP</em></p>

<p>After you select your NTP client you will be asked to chose an APK Mirror, select <code class="language-plaintext highlighter-rouge">r</code> to use a random Mirror and hit enter.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/14.png" alt="Alpine APK Mirror" />
<em>Alpine APK Mirror</em></p>

<p>After that step is complete you will be prompted to create a new user, select your preferred username and password and proceed. For the SSH key keep it as default which is <code class="language-plaintext highlighter-rouge">none</code> and hit enter, then you are asked which SSH server to use leave it as default which is <code class="language-plaintext highlighter-rouge">openssh</code> and hit enter.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/16.png" alt="Alpine user" />
<em>Alpine user</em></p>

<p>Next will be to select the disk to install our OS. Over here you will be prompted which disk to use, here select the virtual hard disk that you created which is called <code class="language-plaintext highlighter-rouge">sda</code> in my case. Once the disk is selected we are prompted how would we like to use it, here select <code class="language-plaintext highlighter-rouge">sys</code> to install the system. Now we are asked if we are okay with erasing the disk, select <code class="language-plaintext highlighter-rouge">y</code> since this only erases the virtual hard disk we created. Once this is done the OS will install and it will take some time.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/19.png" alt="Alpine disk &amp; install" />
<em>Alpine disk &amp; install</em></p>

<p>Once the installation is one we are asked to reboot, so type <code class="language-plaintext highlighter-rouge">reboot</code> or simply hit the Virtual Box Host(on windows it is the right ctrl button) + Q and shut down your machine.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/20.png" alt="Alpine reboot" />
<em>Alpine reboot</em></p>

<p>Once the machine has shut down, go to its settings and navigate to the storage section and remove the <code class="language-plaintext highlighter-rouge">alpine standard ISO</code> file so our machine will boot to the OS and not the installer the next time we run it.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/21.png" alt="VM remove attachment" />
<em>VM remove attachment</em></p>

<p>Once you remove the attachment start the VM again and you will be booted into Alpine Linux, here log in as <code class="language-plaintext highlighter-rouge">root</code> and enter the password you set for <code class="language-plaintext highlighter-rouge">root</code>.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/22.png" alt="Alpine Log in" />
<em>Alpine Log in</em></p>

<h3 id="dnsmasq-installation">dnsmasq Installation</h3>
<p>Once you are logged in as root type this in the terminal to update packages.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">apk update
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/23.png" alt="Alpine update" />
<em>Alpine update</em></p>

<p>Once it is done to install <code class="language-plaintext highlighter-rouge">dnsmasq</code> type this in the terminal.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">apk add dnsmasq
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/24.png" alt="Alpine dnsmasq" />
<em>Alpine dnsmasq</em></p>

<h2 id="network-configuration">Network configuration</h2>
<p>Once <code class="language-plaintext highlighter-rouge">dnsmasq</code> is installed shut down your machine using <code class="language-plaintext highlighter-rouge">Host + Q</code> and open the Machine settings and navigate to the Network section. Then under the Attached to section select it as Internal Network and for the name we will select the same network our kali machine is under, which is named SOC. Now save the settings and click ok.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/25.png" alt="VM Network" />
<em>VM Network</em></p>

<h3 id="static-ip-configuration">Static IP configuration</h3>
<p>Once the VM is on the internal network boot it up again and login as <code class="language-plaintext highlighter-rouge">root</code>. Now use <code class="language-plaintext highlighter-rouge">vi</code> to edit the interfaces file to provide a static IP address to our VM in the internal network. To edit the interfaces file type this in the terminal.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">vi /etc/network/interfaces
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/26.png" alt="Alpine interface edit" />
<em>Alpine interface edit</em></p>

<p>In your machine you will see something like ‚Äòiface eth0 inet dhcp‚Äô we will edit this to say static and provide an IP address. In <code class="language-plaintext highlighter-rouge">vi</code> to edit a file click <code class="language-plaintext highlighter-rouge">shift + I</code> to enter insert mode. And then edit the file with this.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> --><td class="rouge-code"><pre><span class="go">auto eth0
iface eth0 inet static
    address 192.168.100.1
    netmask 255.255.255.0
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>Once you have edited the file to save it click <code class="language-plaintext highlighter-rouge">Esc</code> and then type <code class="language-plaintext highlighter-rouge">:wq</code> and hit enter to save the file.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/27.png" alt="Edited Interface" />
<em>Edited Interface</em></p>

<p>Once it is done to confirm if the file is edited <code class="language-plaintext highlighter-rouge">cat</code> the file to check if it is edited, and as we can see it is edited. So now we can restart the service by using the following command.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">rc-service networking restart
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/28.png" alt="Restarting network service" />
<em>Restarting network service</em></p>

<p>Once the service is restarted type in the following command to check if the IP address is assigned properly. And to confirm you should see something like <code class="language-plaintext highlighter-rouge">inet 192.168.100.1/24</code> in eth0.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">ip a
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/29.png" alt="Confirming the IP address" />
<em>Confirming the IP address</em></p>

<h2 id="dnsmasq-configuration">dnsmasq Configuration</h2>
<p>Once the machine has an IP we can move on to edit the dnsmasq.conf file to serve IP addresses to machines on this network. To edit the conf file type this into your terminal.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">vi /ect/dnsmasq.conf
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/30.png" alt="dnsmasq config" />
<em>dnsmasq config edit</em></p>

<p>Once you do this you will see a huge list. Scroll to the bottom of the file and hit <code class="language-plaintext highlighter-rouge">shift + I</code> to enter insert mode so we can edit this file.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/31.png" alt="vi dnsmasq" />
<em>vi dnsmasq</em></p>

<p>Once you are in insert mode do the following edit and save the file by clicking <code class="language-plaintext highlighter-rouge">Esc</code> and <code class="language-plaintext highlighter-rouge">:wq</code> and hit enter to save it.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td> --><td class="rouge-code"><pre><span class="gp">#</span><span class="w"> </span>Bind to eth0 only
<span class="go">interface=eth0
bind-interfaces

</span><span class="gp">#</span><span class="w"> </span>DHCP address pool and lease <span class="nb">time</span>
<span class="go">dhcp-range=192.168.100.10,192.168.100.100,12h

</span><span class="gp">#</span><span class="w"> </span>Gateway address sent to clients
<span class="go">dhcp-option=3,192.168.100.1

</span><span class="gp">#</span><span class="w"> </span>DNS servers sent to clients <span class="o">(</span>just this server <span class="k">for </span>isolated network<span class="o">)</span>
<span class="go">dhcp-option=6,192.168.100.1

</span><span class="gp">#</span><span class="w"> </span>Enable logging <span class="o">(</span>optional<span class="o">)</span>
<span class="go">log-dhcp
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/32.png" alt="dnsmasq edit" />
<em>dnsmasq edit</em></p>

<p>Now everything is set all we have to do is start the service to do so type this in the terminal.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">rc-service dnsmasq start
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/33.png" alt="dnsmasq service start" />
<em>dnsmasq service start</em></p>

<p>If you want to check if the service is running type this in the terminal to check its status.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">rc-service dnsmasq status
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/34.png" alt="dnsmasq status" />
<em>dnsmasq status</em></p>

<p>Now for the moment of truth, boot up the kali virtual machine that we created on our <a href="https://mrprimezero.github.io/posts/homelab_kalilinux/">previous post</a> and when we run <code class="language-plaintext highlighter-rouge">ifconfig</code> we can see that the DHCP server has provided an IP address to our machine.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/35.png" alt="Kali IP" />
<em>Kali IP</em></p>

<p>Once we see the IP address just to double check let‚Äôs run <code class="language-plaintext highlighter-rouge">ping</code> on our server and ping the kali machine to see if it responds. As per the below image it is a success.</p>

<p><img src="/assets/img/posts/homelab/dnsmasq_dhcp/36.png" alt="Ping" />
<em>Ping</em></p>

<p>To make it easier we can also add dnsmasq to automatically run everytime we boot up Alpine Linux by using this command.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
</pre></td> --><td class="rouge-code"><pre><span class="go">rc-update add dnsmasq default
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>
<p>We have successfully built a dedicated, isolated network with a centralized DHCP and DNS server. By using the lightweight Alpine Linux and the powerful dnsmasq utility, we have eliminated the need for manually configuring IP addresses on every new machine. This makes our home lab more efficient and provides a realistic environment for our future projects.</p>

<p>With our attacker machine and a secure, controlled network now in place, we have all the foundational components to begin our hands-on exercises.</p>

<p>In the next post, we will introduce our first target: Metasploitable 2. This intentionally vulnerable machine will allow us to immediately apply our Kali Linux skills and begin generating the security events and logs that we will later use to build our SIEM (Security Information and Event Management) platform.</p>

<p>Stay tuned for the next installment of our home lab series!</p>
:ET